<p-panel styleClass="hospedes-panel">
  <ng-template pTemplate="header">
    <div class="panel-header">
      <div class="panel-header__titles">
        <h2>Hóspedes</h2>
        <p class="subtitle">Visualize e gerencie os cadastros importados do hotel.</p>
      </div>
      <div class="panel-header__actions">
        <p-select
          [options]="statusOptions"
          [(ngModel)]="filterStatus"
          optionLabel="label"
          optionValue="value"
          placeholder="Filtrar por status"
          [showClear]="true"
          (onChange)="onFilterChange()"
        ></p-select>
        <span class="p-input-icon-left filter-input">
          <i class="pi pi-search"></i>
          <input
            type="text"
            pInputText
            placeholder="Filtrar hóspedes"
            [(ngModel)]="filterTerm"
            (ngModelChange)="onFilterChange()"
          />
        </span>
        <p-button
          label="Buscar compatibilidade de todos"
          icon="pi pi-sync"
          (click)="buscarCompatibilidadeTodos()"
          [loading]="buscandoCompatibilidadeTodos"
          [disabled]="buscandoCompatibilidadeTodos"
        ></p-button>
        <p-button label="Importar planilha" icon="pi pi-upload" [routerLink]="['/hospedes/import']"></p-button>
      </div>
    </div>
  </ng-template>

  <ng-container *ngIf="paginatedHospedes.length; else emptyState">
    <div class="table-container">
      <table class="hospedes-table">
        <thead>
          <tr>
            <th>Nome</th>
            <th>E-mail</th>
            <th>Telefone</th>
            <th>Chegada</th>
            <th>Partida</th>
            <th>Status</th>
            <th class="actions-column">Ações</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let h of paginatedHospedes">
            <td>
              <div class="name-cell">
                <span class="name">{{ h.nome_completo || 'Hóspede sem nome' }}</span>
                <small class="codigo" *ngIf="h.codigo">Código #{{ h.codigo }}</small>
              </div>
            </td>
            <td>{{ h.email || '-' }}</td>
            <td>{{ h.telefone || '-' }}</td>
            <td>{{ h.entrada || '-' }}</td>
            <td>{{ h.saida || '-' }}</td>
            <td>
              <span *ngIf="h.status == 3" class="status-integrado">
                <i class="pi pi-check-circle"></i> {{ getStatusLabel(h.status) }}
              </span>
              <span *ngIf="h.status != 3">{{ getStatusLabel(h.status) }}</span>
            </td>
            <td>
              <div class="actions">
                <p-button icon="pi pi-search" rounded (click)="showDetalhes(h)" [text]="true"></p-button>
                <p-button icon="pi pi-list" rounded (click)="showLogs(h)" [text]="true" severity="secondary"></p-button>
                <!-- Botão de editar (apenas para status 1 e 2) -->
                <p-button
                  *ngIf="h.status != 3"
                  icon="pi pi-pencil"
                  rounded
                  (click)="editHospede(h)"
                  [text]="true"
                  severity="info"
                ></p-button>
                <!-- Status 1: Importado - Mostrar botão de Buscar Compatibilidade -->
                <p-button
                  *ngIf="h.status == 1"
                  label="Compatibilidade"
                  icon="pi pi-search"
                  (click)="buscarCompatibilidade(h)"
                  [loading]="buscandoCompatibilidade[h.id]"
                  [disabled]="buscandoCompatibilidadeTodos"
                  size="small"
                  [outlined]="true"
                ></p-button>
                <!-- Status 2: Compatível - Mostrar botão de Atualizar FNRH -->
                <p-button
                  *ngIf="h.status == 2"
                  label="Atualizar FNRH"
                  icon="pi pi-sync"
                  (click)="atualizarOracle(h)"
                  [loading]="atualizandoOracle[h.id]"
                  severity="success"
                  size="small"
                  [outlined]="true"
                ></p-button>
                <!-- Status 3: Integrado - Nenhum botão de ação adicional -->
                <p-button
                  *ngIf="h.status != 3"
                  icon="pi pi-trash"
                  severity="danger"
                  (click)="remove(h)"
                  rounded
                  outlined
                ></p-button>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </ng-container>
</p-panel>

<ng-template #emptyState>
  <ng-container *ngIf="!filterTerm; else filteredEmpty">
    <div class="empty-state">
      <i class="pi pi-users"></i>
      <h3>Nenhum hóspede encontrado</h3>
      <p>Importe uma planilha para começar a visualizar os registros.</p>
    </div>
  </ng-container>
</ng-template>

<ng-template #filteredEmpty>
  <div class="empty-state">
    <i class="pi pi-search"></i>
    <h3>Nenhum resultado para o filtro</h3>
    <p>Altere os termos de busca para visualizar outros registros.</p>
  </div>
</ng-template>

<p-paginator
  *ngIf="totalRecords"
  [first]="page * rows"
  [rows]="rows"
  [rowsPerPageOptions]="[10, 20, 50]"
  [totalRecords]="totalRecords"
  (onPageChange)="onPageChange($event)"
></p-paginator>

<p-dialog
  [(visible)]="detailDialogVisible"
  [modal]="true"
  [style]="{ width: '640px' }"
  [breakpoints]="{ '960px': '90vw' }"
  [draggable]="false"
  appendTo="body"
  styleClass="detalhes-dialog"
  (onHide)="onDialogHide()"
  [header]="selectedHospede?.nome_completo || 'Detalhes do hóspede'"
>
  <div class="dialog-header-info" *ngIf="selectedHospede">
    <p-tag
      *ngIf="selectedHospede.apto; else semApartamento"
      severity="info"
      [value]="'Apto ' + selectedHospede.apto"
    ></p-tag>
    <ng-template #semApartamento>
      <p-tag severity="warning" value="Apto não informado"></p-tag>
    </ng-template>
    <span class="dialog-codigo" *ngIf="selectedHospede.codigo">Código #{{ selectedHospede.codigo }}</span>
  </div>

  <div class="info-grid" *ngIf="selectedHospede">
    <div class="info-item">
      <span class="label">E-mail</span>
      <span class="value">{{ selectedHospede.email || '-' }}</span>
    </div>
    <div class="info-item">
      <span class="label">Telefone</span>
      <span class="value">{{ selectedHospede.telefone || '-' }}</span>
    </div>
    <div class="info-item">
      <span class="label">Profissão</span>
      <span class="value">{{ selectedHospede.profissao || '-' }}</span>
    </div>
    <div class="info-item">
      <span class="label">Documento</span>
      <span class="value">{{ selectedHospede.identidade || selectedHospede.cpf || '-' }}</span>
    </div>
    <div class="info-item">
      <span class="label">Nascimento</span>
      <span class="value">{{ selectedHospede.data_nascimento || '-' }}</span>
    </div>
    <div class="info-item">
      <span class="label">Sexo</span>
      <span class="value">{{ selectedHospede.sexo || '-' }}</span>
    </div>
    <div class="info-item">
      <span class="label">Endereço</span>
      <span class="value">{{ selectedHospede.endereco || '-' }}</span>
    </div>
    <div class="info-item">
      <span class="label">Cidade/UF</span>
      <span class="value">{{ selectedHospede.cidade || '-' }} - {{ selectedHospede.estado || '-' }}</span>
    </div>
    <div class="info-item">
      <span class="label">País</span>
      <span class="value">{{ selectedHospede.pais || '-' }}</span>
    </div>
    <div class="info-item">
      <span class="label">CEP</span>
      <span class="value">{{ selectedHospede.cep || '-' }}</span>
    </div>
    <div class="info-item">
      <span class="label">Entrada</span>
      <span class="value">{{ selectedHospede.entrada || '-' }}</span>
    </div>
    <div class="info-item">
      <span class="label">Saída</span>
      <span class="value">{{ selectedHospede.saida || '-' }}</span>
    </div>
    <div class="info-item">
      <span class="label">Status</span>
      <span class="value">{{ getStatusLabel(selectedHospede.status) }}</span>
    </div>
    <div class="info-item">
      <span class="label">ID Hóspede Oracle</span>
      <span class="value">{{ selectedHospede.idhospede || '-' }}</span>
    </div>
    <div class="info-item">
      <span class="label">ID Reserva Oracle</span>
      <span class="value">{{ selectedHospede.idreservasfront || '-' }}</span>
    </div>
  </div>
</p-dialog>

<p-dialog
  [(visible)]="logsDialogVisible"
  [modal]="true"
  [style]="{ width: '900px' }"
  [breakpoints]="{ '960px': '95vw' }"
  [draggable]="false"
  appendTo="body"
  styleClass="logs-dialog"
  [header]="'Logs de Integração - ' + (selectedHospedeForLogs?.nome_completo || '')"
>
  <div *ngIf="loadingLogs" style="text-align: center; padding: 2rem;">
    <i class="pi pi-spin pi-spinner" style="font-size: 2rem;"></i>
    <p>Carregando logs...</p>
  </div>

  <div *ngIf="!loadingLogs && hospedeLogsList.length === 0" style="text-align: center; padding: 2rem;">
    <i class="pi pi-info-circle" style="font-size: 2rem; color: #999;"></i>
    <p>Nenhum log encontrado para este hóspede</p>
  </div>

  <p-table
    *ngIf="!loadingLogs && hospedeLogsList.length > 0"
    [value]="hospedeLogsList"
    styleClass="p-datatable-sm"
  >
    <ng-template pTemplate="header">
      <tr>
        <th style="width: 100px">Chegada</th>
        <th style="width: 100px">Partida</th>
        <th style="width: 120px">Tipo</th>
        <th>Mensagem</th>
        <th style="width: 160px">Data/Hora</th>
      </tr>
    </ng-template>
    <ng-template pTemplate="body" let-log>
      <tr>
        <td>{{ log.data_chegada || '-' }}</td>
        <td>{{ log.data_partida || '-' }}</td>
        <td>
          <p-tag
            [value]="getTipoAcaoLabel(log.tipo_acao)"
            [severity]="getTipoAcaoSeverity(log.tipo_acao)"
          ></p-tag>
        </td>
        <td>{{ log.mensagem }}</td>
        <td>{{ formatDateTime(log.created_at) }}</td>
      </tr>
    </ng-template>
  </p-table>
</p-dialog>

<p-dialog
  [(visible)]="editDialogVisible"
  [modal]="true"
  [style]="{ width: '800px' }"
  [breakpoints]="{ '960px': '95vw' }"
  [draggable]="false"
  appendTo="body"
  styleClass="edit-dialog"
  [header]="'Editar Hóspede - ' + (hospedeEmEdicao?.nome_completo || '')"
>
  <div *ngIf="hospedeEmEdicao" class="edit-form">
    <div class="form-grid">
      <div class="form-item">
        <label for="nome">Nome Completo</label>
        <input id="nome" type="text" pInputText [(ngModel)]="hospedeEmEdicao.nome_completo" />
      </div>

      <div class="form-item">
        <label for="codigo">Código</label>
        <input id="codigo" type="text" pInputText [(ngModel)]="hospedeEmEdicao.codigo" />
      </div>

      <div class="form-item">
        <label for="email">E-mail</label>
        <input id="email" type="email" pInputText [(ngModel)]="hospedeEmEdicao.email" />
      </div>

      <div class="form-item">
        <label for="telefone">Telefone</label>
        <input id="telefone" type="text" pInputText [(ngModel)]="hospedeEmEdicao.telefone" />
      </div>

      <div class="form-item">
        <label for="cpf">CPF</label>
        <input id="cpf" type="text" pInputText [(ngModel)]="hospedeEmEdicao.cpf" />
      </div>

      <div class="form-item">
        <label for="identidade">Identidade</label>
        <input id="identidade" type="text" pInputText [(ngModel)]="hospedeEmEdicao.identidade" />
      </div>

      <div class="form-item">
        <label for="profissao">Profissão</label>
        <input id="profissao" type="text" pInputText [(ngModel)]="hospedeEmEdicao.profissao" />
      </div>

      <div class="form-item">
        <label for="data_nascimento">Data de Nascimento</label>
        <input id="data_nascimento" type="text" pInputText [(ngModel)]="hospedeEmEdicao.data_nascimento" />
      </div>

      <div class="form-item">
        <label for="sexo">Sexo</label>
        <input id="sexo" type="text" pInputText [(ngModel)]="hospedeEmEdicao.sexo" />
      </div>

      <div class="form-item">
        <label for="apto">Apartamento</label>
        <input id="apto" type="text" pInputText [(ngModel)]="hospedeEmEdicao.apto" />
      </div>

      <div class="form-item full-width">
        <label for="endereco">Endereço</label>
        <input id="endereco" type="text" pInputText [(ngModel)]="hospedeEmEdicao.endereco" />
      </div>

      <div class="form-item">
        <label for="numero">Número</label>
        <input id="numero" type="text" pInputText [(ngModel)]="hospedeEmEdicao.numero" />
      </div>

      <div class="form-item">
        <label for="complemento">Complemento</label>
        <input id="complemento" type="text" pInputText [(ngModel)]="hospedeEmEdicao.complemento" />
      </div>

      <div class="form-item">
        <label for="bairro">Bairro</label>
        <input id="bairro" type="text" pInputText [(ngModel)]="hospedeEmEdicao.bairro" />
      </div>

      <div class="form-item">
        <label for="cidade">Cidade</label>
        <input id="cidade" type="text" pInputText [(ngModel)]="hospedeEmEdicao.cidade" />
      </div>

      <div class="form-item">
        <label for="estado">Estado</label>
        <input id="estado" type="text" pInputText [(ngModel)]="hospedeEmEdicao.estado" />
      </div>

      <div class="form-item">
        <label for="pais">País</label>
        <input id="pais" type="text" pInputText [(ngModel)]="hospedeEmEdicao.pais" />
      </div>

      <div class="form-item">
        <label for="cep">CEP</label>
        <input id="cep" type="text" pInputText [(ngModel)]="hospedeEmEdicao.cep" />
      </div>

      <div class="form-item">
        <label for="entrada">Data de Entrada</label>
        <input id="entrada" type="text" pInputText [(ngModel)]="hospedeEmEdicao.entrada" />
      </div>

      <div class="form-item">
        <label for="saida">Data de Saída</label>
        <input id="saida" type="text" pInputText [(ngModel)]="hospedeEmEdicao.saida" />
      </div>
    </div>
  </div>

  <ng-template pTemplate="footer">
    <p-button
      label="Cancelar"
      icon="pi pi-times"
      (click)="cancelEdit()"
      [text]="true"
    ></p-button>
    <p-button
      label="Salvar"
      icon="pi pi-check"
      (click)="saveHospede()"
      [loading]="salvandoHospede"
    ></p-button>
  </ng-template>
</p-dialog>
